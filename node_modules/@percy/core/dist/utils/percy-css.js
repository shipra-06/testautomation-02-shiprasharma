"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = injectPercyCSS;

var _logger = _interopRequireDefault(require("@percy/logger"));

var _resources = require("./resources");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// Creates a local Percy CSS resource and injects a Percy CSS link into the
// provided DOM string. Returns both the new DOM string and local resource
// object. If no Percy CSS is provided the return value will be the original DOM
// string and the function will do nothing.
function injectPercyCSS(rootUrl, originalDOM, percyCSS, meta) {
  if (!percyCSS) return [originalDOM];
  let filename = `percy-specific.${Date.now()}.css`;
  let log = (0, _logger.default)('core');
  log.debug('Handling percy-specific css:', meta);
  log.debug(`-> filename: ${filename}`, meta);
  log.debug(`-> content: ${percyCSS}`, meta);
  let url = `${new URL(rootUrl).origin}/${filename}`;
  let resource = (0, _resources.createLocalResource)(url, percyCSS, 'text/css', null, meta);
  let link = `<link data-percy-specific-css rel="stylesheet" href="/${filename}"/>`;
  let dom = originalDOM.replace(/(<\/body>)(?!.*\1)/is, link + '$&');
  return [dom, resource];
}